{
  "meta": {
    "project": "AI Creative Workshop (Sidebar + Workspace)",
    "date": "2026-01-21",
    "prepared_by": "Generated by Development Manager"
  },
  "product_overview": "AI Creative Workshop is a web application enabling users to interact with an AI-powered image generation service through a sidebar chat and a workspace. Users input text and upload images, receive AI-generated proposal cards with optimized prompts, and then generate new images seamlessly within the workspace. The system logs all generation requests for traceability.",
  "core_goals": [
    "Enable intuitive user input of text and images through a sidebar chat interface.",
    "Provide AI-generated proposal cards that include subject selection, recommended ratios, and final prompts.",
    "Ensure synchronized state between sidebar proposals and workspace input, ratios, and gallery images.",
    "Support streamlined initiation of image generation tasks with responsive UI updates and backend task handling.",
    "Maintain detailed backend logs for all image generation requests to guarantee observability and traceability."
  ],
  "key_features": [
    "Sidebar chat interface accepting multi-line text input and multiple uploaded images to understand user requirements.",
    "Proposal cards from AI with detailed content including module name, subject selection with thumbnails, recommended aspect ratios, and prompts.",
    "Interactive buttons on proposal cards: 'Sync Prompt' to update workspace input and 'Confirm and Generate' to trigger image generation with full parameter sync.",
    "Workspace generation panel featuring prompt input field, aspect ratio selection buttons, and a gallery managing uploaded and reference images.",
    "Image generation process initiating backend API calls, polling for task completion, and rendering resulting images in the preview area.",
    "Robust backend with FastAPI server managing chat, generation endpoints, task polling, and debug logging.",
    "Backend services for chat message handling using a unified director agent, prompt optimization, and integration with image generation provider (BananaService).",
    "Comprehensive logging of all final image generation requests with detailed metadata and image hashes for auditability."
  ],
  "user_flow_summary": [
    "User accesses the web application at root ('/') where the AIChatSidebar and workspace are displayed.",
    "User inputs a multi-line textual prompt and uploads 1 to N images within the sidebar; pressing Enter sends the message, Shift+Enter inserts a newline.",
    "AI processes the input and replies with proposal cards listing module names, recommended aspect ratios, final prompts, and subject image selection including thumbnails if available.",
    "User interacts with proposal cards by clicking 'Sync Prompt' to update the workspace prompt input, or 'Confirm and Generate' to synchronize prompt, ratio, and subject images to the workspace.",
    "Upon confirmation, the workspace updates the prompt input field, adjusts the ratio selection accordingly, and manages the gallery images to prioritize the chosen subject image and include other references.",
    "The workspace generation button automatically triggers the image generation request to the backend, which polls for completion and updates the preview with the generated image.",
    "Backend logs each final image generation request into prompt_debug.log capturing task details, prompt text, and SHA1 hashes of all images involved for traceability."
  ],
  "validation_criteria": [
    "Proposal cards generated by AI must display subject selection information with correct indexing and thumbnail preview for uploaded images.",
    "Clicking 'Confirm and Generate' on a proposal card must update the workspace's gallery with the subject image as the first selected item.",
    "Workspace prompt input and ratio buttons must reflect the values from the confirmed proposal card upon synchronization.",
    "Image generation must be initiated automatically after confirmation, with frontend task polling and preview update successful.",
    "Backend log prompt_debug.log must contain entries labeled FINAL_IMAGE_REQUEST including comprehensive details such as prompt text, images count, and image hashes for each request.",
    "Application must handle multi-line text input correctly in the sidebar with Enter to send and Shift+Enter for line breaks.",
    "System logs and debug files must be maintained as per design for observability and debugging purposes."
  ],
  "code_summary": {
    "tech_stack": [
      "JavaScript (Vanilla) + HTML + CSS",
      "Vite (frontend dev server/build)",
      "Python 3",
      "FastAPI + Uvicorn (backend API server)",
      "Requests (backend HTTP client to LLM/image providers)",
      "Local filesystem storage (static/history JSON+PNG, debug logs)"
    ],
    "features": [
      {
        "name": "Frontend App Shell",
        "description": "Single-page UI for AI image generation: sidebar chat, workspace controls, preview and history.",
        "files": [
          "frontend/index.html",
          "frontend/style.css",
          "frontend/script.js"
        ]
      },
      {
        "name": "AIChatSidebar (Detail Page Mode)",
        "description": "Sidebar chat UI that accepts text + images, calls /api/chat, shows proposal cards, locks Visual DNA, and syncs selected subject/reference images to the workspace before generation.",
        "files": [
          "frontend/script.js",
          "frontend/style.css",
          "frontend/index.html"
        ]
      },
      {
        "name": "Proposal Card Flow",
        "description": "Parses Director-Agent JSON or legacy [GENERATE_IMAGE] blocks into proposal cards; supports 'sync prompt' and 'confirm and generate' actions with ratio and subject image selection.",
        "files": [
          "frontend/script.js",
          "frontend/style.css"
        ]
      },
      {
        "name": "Reference Library (Locked + Auto)",
        "description": "Manages locked reference images and auto-picks history images when none are locked; provides visual feedback in the UI.",
        "files": [
          "frontend/script.js",
          "frontend/style.css"
        ]
      },
      {
        "name": "Workspace Generation Panel",
        "description": "Main workspace prompt input, ratio selection, gallery management, generation button and task polling; sends /api/generate requests and renders results/history.",
        "files": [
          "frontend/script.js",
          "frontend/index.html",
          "frontend/style.css"
        ]
      },
      {
        "name": "Backend API Server",
        "description": "FastAPI server exposing chat and image generation endpoints, static history serving, task polling and debug logging.",
        "files": [
          "backend/main.py"
        ]
      },
      {
        "name": "Chat Service (Unified Director Agent)",
        "description": "Sends multimodal chat requests (text + uploaded images + reference images) to upstream LLM; uses DIRECTOR_AGENT_PROMPT when no Visual DNA exists, and IMAGE_COMPILER_PROMPT when DNA is present.",
        "files": [
          "backend/services/chat_service.py",
          "backend/prompts_v3.py"
        ]
      },
      {
        "name": "Prompt Optimization Service (Dual-Core)",
        "description": "Generates optimized prompts (nano_banana_en/seadream_cn/layout_logic) and writes raw LLM responses to prompt_debug.log for debugging.",
        "files": [
          "backend/services/prompt_service.py"
        ]
      },
      {
        "name": "Image Generation Task Pipeline",
        "description": "Background task that optimizes prompt, selects final_prompt, calls BananaService.generate_image, proxies image to base64, stores history images+metadata, and logs FINAL_IMAGE_REQUEST including prompt and image hashes.",
        "files": [
          "backend/main.py",
          "backend/services/banana_service.py",
          "backend/services/task_service.py"
        ]
      },
      {
        "name": "Image Provider Client (BananaService)",
        "description": "Builds provider-specific payloads for image generation (multipart for img2img, JSON for others), supports aspect ratio/size mapping and optional masks.",
        "files": [
          "backend/services/banana_service.py"
        ]
      },
      {
        "name": "Prompts Library (V3)",
        "description": "Houses system prompts: Unified Director Agent prompt, DNA generator prompt, and image compiler prompt templates.",
        "files": [
          "backend/prompts_v3.py"
        ]
      },
      {
        "name": "Debug & Observability Logs",
        "description": "Writes request sizes to debug.log and writes LLM/FINAL image request records to prompt_debug.log for traceability.",
        "files": [
          "backend/main.py",
          "backend/services/prompt_service.py"
        ]
      }
    ]
  }
}
