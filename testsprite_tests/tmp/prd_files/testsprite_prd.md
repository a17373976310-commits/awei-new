# AI 创意工坊（侧边栏 + 工作区）产品规格说明（用于自动化测试）

## 目标

验证 Web 应用的核心交互闭环：用户在侧边栏输入需求并上传图片 → AI 返回提案卡片（包含主体选择信息与提示词）→ 用户点击“确认并生成”后，工作区正确同步提示词/比例/主体图并发起生成请求 → 后端记录最终生图请求到日志。

## 应用入口

- Web 入口：`/`
- 运行环境：本地开发模式

## 核心模块

### 1) 侧边栏（AIChatSidebar）

#### 1.1 用户输入

- 用户可在侧边栏输入多行文本（Enter 发送，Shift+Enter 换行）。
- 用户可上传 1~N 张图片到侧边栏（用于让 AI 理解产品主体与参考图）。

#### 1.2 AI 回复（提案卡片）

- AI 会在侧边栏返回提案卡片（Proposal Card），卡片应包含：
  - 模块名称（如“封面首图/详情页模块”）
  - 推荐比例（如 3:4 / 4:3 / 1:1）
  - 最终提示词（Prompt）
  - 主体选择信息：显示“主体：第 N 张”，并尽量显示主体缩略图（如果有对应上传图）
- 卡片按钮：
  - “📥 同步”：将 Prompt 同步到工作区的指令输入框
  - “确认并生成”：将 Prompt、比例、主体图同步到工作区，并触发工作区的生成动作

### 2) 工作区（生成面板 + 预览）

#### 2.1 指令输入框

- 工作区存在指令输入框（Prompt Input）。
- 点击侧边栏“📥 同步”后，指令输入框内容应变为提案卡片里的 Prompt。

#### 2.2 比例选择

- 工作区存在比例按钮组（Ratio Buttons），常见值包括：3:4、4:3、1:1。
- 点击侧边栏“确认并生成”后，工作区比例应自动切换到提案卡片推荐值。

#### 2.3 图片库（上传区/图库）

- 工作区维护上传图片库（Gallery）。
- 点击侧边栏“确认并生成”后：
  - 若提案卡片提供主体图，应将主体图置顶并选中；
  - 同步其他参考图（若存在），确保工作区“图片数量”日志能反映同步后的图片数。

#### 2.4 生成按钮

- 工作区存在“应用编辑/生成”按钮。
- 点击侧边栏“确认并生成”后，应自动触发该按钮执行生成流程（前端发起请求 → 后端任务轮询 → 预览更新）。

### 3) 后端（日志可观测性）

- 每次发起图像生成任务时，后端应记录一段 `FINAL_IMAGE_REQUEST` 到 `backend/prompt_debug.log`（或项目根目录同名文件），内容至少包含：
  - task_id / scenario / model / provider / ratio
  - images_count
  - image_0..N 的 bytes 与 sha1（用于确认到底用的是哪张主体图）
  - prompt（最终发送给图像模型的文本）

## 关键测试用例（最小回归）

### 用例 A：提案卡片显示主体选择信息

1. 打开 `/`
2. 在侧边栏上传 2 张图片
3. 输入一句需求并发送
4. 断言：AI 回复出现提案卡片，且卡片显示“主体：第 N 张”

### 用例 B：确认并生成同步主体图到工作区

1. 在提案卡片点击“确认并生成”
2. 断言：工作区图片库第一张为主体图（置顶并选中）
3. 断言：工作区指令输入框与比例已同步

### 用例 C：后端记录最终生图请求

1. 完成一次生成流程（允许使用 mock/快速生成模型）
2. 断言：`prompt_debug.log` 中存在 `FINAL_IMAGE_REQUEST` 段落，且包含 prompt 与 images_count

## 非目标

- 不要求本阶段验证生成图片的美学质量。
- 不要求验证所有模型提供商，仅验证默认配置下的端到端链路可跑通。

