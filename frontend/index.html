<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI 绘图 - Nano Banana 2</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./style.css">
    <link rel="stylesheet" href="./tailwind.css">
</head>

<body>
    <div id="app">
        <header class="app-header">
            <div class="header-left">
                <h1
                    style="font-size: 1.25rem; font-weight: 600; background: linear-gradient(to right, #fff, #a5b4fc); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">
                    AI 创意工坊</h1>
                <button id="open-api-settings" class="api-settings-btn" aria-label="配置 API 提供商">
                    <span class="dot"></span>
                    配置 API 提供商
                </button>
            </div>
            <nav class="mode-switch">
                <button id="btn-img2img" class="nav-btn active" aria-label="图生图模式">图生图</button>
            </nav>
        </header>

        <main class="main-content">
            <div class="workspace-main">
                <div class="workspace-top">
                    <!-- Middle Panel: Controls -->
                    <aside class="left-panel">
                        <div id="controls-container">
                            <!-- Image Upload (Img2Img only) -->
                            <div id="group-image" class="control-group hidden">
                                <label>源图像</label>
                                <div class="upload-zone" id="upload-zone">
                                    <div class="upload-content">
                                        <span class="icon">+</span>
                                        <p>拖拽或粘贴图像</p>
                                        <span class="sub-text">支持多图上传</span>
                                    </div>
                                    <input type="file" id="file-input" accept="image/*" multiple hidden>
                                    <canvas id="mask-canvas"></canvas>
                                </div>
                                <!-- Thumbnail Gallery -->
                                <div id="upload-gallery" class="upload-gallery hidden"></div>
                            </div>

                            <!-- Model Selector -->
                            <div class="control-group">
                                <label>选择模型</label>
                                <select id="model-select" class="model-select">
                                    <option value="comfly_nano_banana">Comfly Nano Banana 2 (官方源)</option>
                                    <option value="nano_banana_2_2k">Nano Banana 2-2k (高清版)</option>
                                    <option value="nano_banana_2_4k">Nano Banana 2-4k (超高清版)</option>
                                    <option value="nano_banana_official">Nano Banana (Google)</option>
                                    <option value="doubao_seedream_4_0">Doubao Seedream 4.0 (即梦4)</option>
                                    <option value="doubao_seedream_4_5">Doubao Seedream 4.5 (即梦4.5)</option>
                                    <option value="gpt_image_1_5">GPT-Image-1.5 (OpenAI)</option>
                                </select>
                            </div>

                            <!-- Scenario Selector -->
                            <div id="group-scenario" class="control-group">
                                <label>应用场景</label>
                                <div class="scenario-selector">
                                    <button class="scenario-btn active" data-value="free_mode">通用模式</button>
                                    <button class="scenario-btn" data-value="ecommerce">电商模式</button>
                                </div>

                                <!-- Sub-Scenario (Hidden by default) -->
                                <div id="sub-scenario-container" class="sub-scenario-wrapper hidden">
                                    <div class="scenario-group">
                                        <div class="group-label">电商平台 (Platforms)</div>
                                        <div class="group-btns">
                                            <button class="scenario-btn sub-btn active"
                                                data-value="taobao_main">淘宝主图</button>
                                            <button class="scenario-btn sub-btn"
                                                data-value="taobao_detail">详情场景</button>
                                            <button class="scenario-btn sub-btn"
                                                data-value="amazon_white">亚马逊白底</button>
                                            <button class="scenario-btn sub-btn"
                                                data-value="amazon_detail">亚马逊A+</button>
                                        </div>
                                    </div>
                                    <div class="scenario-group">
                                        <div class="group-label">详情页设计 (Detail Pages)</div>
                                        <div class="group-btns">
                                            <button class="scenario-btn sub-btn"
                                                data-value="taobao_detail">淘宝详情</button>
                                            <button class="scenario-btn sub-btn"
                                                data-value="taobao_detail_suite">整套详情页</button>
                                            <button class="scenario-btn sub-btn"
                                                data-value="amazon_detail">亚马逊A+</button>
                                        </div>
                                    </div>
                                    <div class="scenario-group">
                                        <div class="group-label">创意设计 (Creative)</div>
                                        <div class="group-btns">
                                            <button class="scenario-btn sub-btn" data-value="brand_story">品牌故事</button>
                                            <button class="scenario-btn sub-btn"
                                                data-value="creative_poster">创意海报</button>
                                        </div>
                                    </div>
                                    <div class="scenario-group">
                                        <div class="group-label">辅助工具 (Tools)</div>
                                        <div class="group-btns">
                                            <button class="scenario-btn sub-btn" data-value="image_modify">图像修改</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Aspect Ratio -->
                            <div class="control-group">
                                <label>输出尺寸</label>
                                <div class="ratio-grid" id="ratio-grid">
                                    <!-- Ratios injected by JS -->
                                </div>
                            </div>

                            <!-- Prompt -->
                            <div class="control-group">
                                <label>你的指令</label>
                                <textarea id="prompt-input" placeholder="例如：'把背景换成未来城市的夜景' 或 '添加复古滤镜'"></textarea>
                            </div>

                            <!-- Generate Button -->
                            <button id="generate-btn" class="primary-btn">
                                <span class="icon">✨</span> 应用编辑
                            </button>

                            <!-- Cancel Button (hidden by default) -->
                            <button id="cancel-btn" class="cancel-btn hidden">
                                <span class="icon">⏸️</span> 取消任务
                            </button>
                        </div>
                    </aside>

                    <!-- Right Panel: Preview -->
                    <section class="right-panel">
                        <div id="preview-container" class="preview-area">
                            <div class="empty-state">
                                <span class="icon">✨</span>
                                <p>您生成的图像将显示在此处。</p>
                            </div>
                        </div>
                    </section>
                </div>

                <div class="workspace-bottom">
                    <!-- Bottom Panel: History -->
                    <section class="history-section">
                        <h3>历史记录</h3>
                        <div class="history-list" id="history-list">
                            <!-- History items injected by JS -->
                            <div class="history-empty">你的生成历史将显示在这里</div>
                        </div>
                    </section>

                    <!-- Work Log Section -->
                    <section class="log-section">
                        <div class="log-header">
                            <h3>工作日志</h3>
                            <button id="clear-log-btn" class="clear-log-btn">清空</button>
                        </div>
                        <div class="log-list" id="log-list">
                            <div class="log-empty">工作日志将显示在这里</div>
                        </div>
                    </section>
                </div>
            </div>

            <!-- Sidebar Resizer -->
            <div id="sidebar-resizer" class="sidebar-resizer"></div>

            <!-- Floating Open Button (Visible when sidebar is collapsed) -->
            <button id="open-sidebar-float-btn" class="open-sidebar-float-btn hidden" title="展开 AI 助手">
                <span class="icon">🤖</span>
            </button>

            <!-- AI Chat Sidebar -->
            <aside class="ai-sidebar" id="ai-sidebar">
                <div class="sidebar-header">
                    <div class="header-top-row">
                        <div class="header-title">
                            <span class="icon">🤖</span>
                            <span>AI 视觉总监</span>
                        </div>
                        <button id="toggle-sidebar" class="toggle-btn-header">
                            <span class="icon">➡️</span>
                        </button>
                    </div>
                    
                    <div class="model-selectors">
                        <select id="reasoning-model-select" class="mini-selector" title="推理模型">
                            <option value="gpt-5.2-2025-12-11">GPT-5.2 (Preview)</option>
                            <option value="gemini-3-flash-preview-thinking-*" selected>Gemini 3.0 Flash Thinking</option>
                            <option value="deepseek-r1">DeepSeek R1</option>
                        </select>
                        <select id="image-model-select" class="mini-selector" title="绘图模型">
                            <option value="nano-banana-2">Nano Banana 2</option>
                            <option value="nano-banana-2-2k">Nano Banana 2k</option>
                            <option value="nano-banana-2-4k">Nano Banana 4k</option>
                        </select>
                        <button id="reset-session-btn" class="mini-btn-red" title="重置会话">
                            🗑️ 重置
                        </button>
                    </div>

                    <div class="header-controls" style="margin-top: 8px; justify-content: space-between;">
                        <!-- Mode Toggles -->
                        <div class="mode-toggle-pill">
                            <div class="mode-pill active" id="mode-detail-btn">详情页</div>
                            <div class="mode-pill" id="mode-chat-btn">对话</div>
                        </div>

                        <!-- Grounding Toggle -->
                        <div class="grounding-toggle-container" id="grounding-toggle-parent" title="启用 Google 搜索增强">
                            <input type="checkbox" id="grounding-toggle" class="grounding-checkbox">
                            <label for="grounding-toggle" class="grounding-label">
                                <span class="icon">🌐</span> 联网
                            </label>
                        </div>
                    </div>
                </div>

                <!-- DNA Badge Area -->
                <div id="dna-badge-container" style="padding: 0 1rem; margin-top: 0.5rem;"></div>

                <!-- Asset Vault (Dual Track) -->
                <div id="asset-vault" class="asset-vault">
                    <div class="vault-header">
                        <span>📦 素材库 (Asset Vault)</span>
                    </div>
                    
                    <!-- Track A: Appearance -->
                    <div class="asset-track">
                        <div class="track-header">
                            <span class="track-title">TRACK A: 外观/角度 (Subject Lock)</span>
                            <button class="track-add-btn" id="add-track-a" title="添加外观图">+</button>
                            <input type="file" id="track-a-input" accept="image/*" multiple hidden>
                        </div>
                        <div class="track-scroll" id="track-a-scroll">
                            <!-- Track A Items -->
                            <span class="track-hint">上传产品各角度外观图...</span>
                        </div>
                    </div>

                    <!-- Track B: Logic/Context -->
                    <div class="asset-track">
                        <div class="track-header">
                            <span class="track-title">TRACK B: 逻辑/功能 (Logic Context)</span>
                            <button class="track-add-btn" id="add-track-b" title="添加逻辑图">+</button>
                            <input type="file" id="track-b-input" accept="image/*" multiple hidden>
                        </div>
                        <div class="track-scroll" id="track-b-scroll">
                            <!-- Track B Items -->
                            <span class="track-hint">上传功能演示或结构图...</span>
                        </div>
                    </div>
                </div>

                <!-- Chat Messages -->
                <div id="chat-messages" class="chat-container custom-scrollbar">
                    <div class="message system">
                        👋 您好！我是您的电商视觉总监。请上传产品图片（Track A）和功能参考图（Track B），我将为您规划视觉方案。
                    </div>
                </div>

                <!-- Reference Library (Hidden / Legacy) -->
                <div id="reference-library" class="reference-library">
                    <div class="lib-header">
                        <span>🔒 锁定参考 (<span id="ref-count">0</span>)</span>
                    </div>
                    <div class="lib-scroll" id="ref-scroll"></div>
                </div>

                <!-- Chat Input -->
                <div class="chat-input-area">
                    <!-- Image Preview for Chat Input -->
                    <div id="image-preview-container" class="image-preview-container hidden"></div>
                    
                    <div class="chat-input-container">
                        <button class="upload-icon-btn" id="chat-upload-btn" title="上传参考图">
                            📷
                        </button>
                        <input type="file" id="chat-file-input" accept="image/*" multiple hidden>
                        
                        <textarea id="chat-input" placeholder="输入您的设计需求... (支持粘贴图片)" rows="1"></textarea>
                        
                        <button id="send-chat-btn" class="send-btn">
                            ➤
                        </button>
                    </div>
                </div>
            </aside>
        </main>

        <!-- History Detail Modal -->
        <div id="image-modal" class="modal hidden">
            <div class="modal-content">
                <span class="close-modal">&times;</span>
                <div class="modal-body">
                    <div class="modal-image-container">
                        <img id="modal-image" src="" alt="Detail View">
                    </div>
                    <div class="modal-details">
                        <div class="detail-group">
                            <h4>原始提示词</h4>
                            <p id="modal-prompt"></p>
                        </div>
                        <div id="modal-optimized-group" class="detail-group">
                            <h4>优化后提示词</h4>
                            <p id="modal-optimized-prompt"></p>
                        </div>
                        <div id="modal-original-image-group" class="detail-group hidden">
                            <h4>参考原图</h4>
                            <div class="modal-original-gallery"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- API Provider Settings Modal -->
    <div id="api-settings-modal" class="modal hidden">
        <div class="modal-content api-modal">
            <span class="close-modal" id="close-api-settings">&times;</span>
            <div class="api-modal-header">
                <h2>API 提供商设置</h2>
                <p>配置您的自定义 API 节点与密钥</p>
            </div>
            <div class="api-provider-list" id="api-provider-list">
                <!-- Providers will be injected here -->
            </div>
            <div class="api-modal-actions">
                <button id="add-provider-btn" class="add-new-btn">
                    <span class="icon">+</span> 添加新提供商
                </button>
                <button id="finish-api-settings" class="finish-btn">完成</button>
            </div>
        </div>
    </div>

    <!-- API Provider Edit Modal -->
    <div id="api-edit-modal" class="modal hidden">
        <div class="modal-content api-edit-modal">
            <span class="close-modal" id="close-api-edit">&times;</span>
            <div class="api-modal-header">
                <h2 id="edit-modal-title">添加提供商</h2>
            </div>
            <form id="api-provider-form" class="api-form">
                <input type="hidden" id="edit-provider-id">
                <div class="form-row">
                    <div class="form-group">
                        <label>提供商名称</label>
                        <input type="text" id="provider-name" placeholder="例如: comfly测试" required>
                    </div>
                    <div class="form-group">
                        <label>API 格式</label>
                        <select id="provider-format">
                            <option value="openai">OpenAI 兼容</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>API 基础地址 (BASE URL)</label>
                    <input type="text" id="provider-url" placeholder="https://ai.comfly.chat/v1" required>
                </div>
                <div class="form-group">
                    <label>API 密钥 (KEY)</label>
                    <input type="password" id="provider-key" placeholder="sk-..." required>
                </div>
                <div class="form-group">
                    <label>支持的模型 (常规 - 逗号分隔)</label>
                    <textarea id="provider-models" placeholder="所有" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label>图像模型 (逗号分隔)</label>
                    <textarea id="provider-img-models" placeholder="nano-banana-2, nano-banana-2-2k..."
                        rows="2"></textarea>
                </div>
                <div class="form-check">
                    <input type="checkbox" id="provider-default">
                    <label for="provider-default">设为默认提供商</label>
                </div>
                <div class="form-actions">
                    <button type="submit" class="save-btn">保存配置</button>
                    <button type="button" id="cancel-api-edit" class="cancel-btn-alt">取消</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Markdown Rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Main Script -->
    <script type="module" src="./script.js"></script>


</body>

</html>
